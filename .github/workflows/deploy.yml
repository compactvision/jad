name: Deploy Laravel + Inertia to NitroHost

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to NitroHost
      env:
        SSH_USER: ${{ secrets.SSH_USER }}
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_PORT: ${{ secrets.SSH_PORT }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        ssh -p $SSH_PORT $SSH_USER@$SSH_HOST << 'ENDSSH'
          set -e
          
          echo "ðŸ“¦ DÃ©but du dÃ©ploiement..."
          cd ${{ secrets.DEPLOY_PATH }}
          
          # Clone ou pull le repository
          if [ ! -d ".git" ]; then
            echo "ðŸ”„ Clonage du repository..."
            git clone git@github.com:compactvision/jad.git .
          else
            echo "ðŸ”„ Mise Ã  jour du code..."
            git fetch origin
            git reset --hard origin/main
          fi
          
          # Copier le fichier .env s'il n'existe pas
          if [ ! -f ".env" ]; then
            echo "ðŸ“ CrÃ©ation du fichier .env..."
            cp .env.example .env
            
            # Configurer les variables d'environnement
            sed -i "s/DB_HOST=.*/DB_HOST=${{ secrets.DB_HOST }}/" .env
            sed -i "s/DB_DATABASE=.*/DB_DATABASE=${{ secrets.DB_DATABASE }}/" .env
            sed -i "s/DB_USERNAME=.*/DB_USERNAME=${{ secrets.DB_USERNAME }}/" .env
            sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=${{ secrets.DB_PASSWORD }}/" .env
            sed -i "s/APP_ENV=.*/APP_ENV=production/" .env
            sed -i "s/APP_DEBUG=.*/APP_DEBUG=false/" .env
          fi
          
          # Installer les dÃ©pendances PHP
          echo "ðŸ“¥ Installation des dÃ©pendances PHP..."
          composer install --no-dev --optimize-autoloader --no-interaction
          
          # Installer les dÃ©pendances NPM et build
          echo "ðŸ“¥ Installation des dÃ©pendances NPM..."
          npm ci
          
          echo "ðŸ”¨ Build des assets..."
          npm run build
          
          # GÃ©nÃ©rer la clÃ© d'application si nÃ©cessaire
          if ! grep -q "APP_KEY=base64:" .env; then
            echo "ðŸ”‘ GÃ©nÃ©ration de la clÃ© d'application..."
            php artisan key:generate --force
          fi
          
          # Migrations et cache
          echo "ðŸ—„ï¸ ExÃ©cution des migrations..."
          php artisan migrate --force
          
          echo "ðŸ§¹ Nettoyage du cache..."
          php artisan config:clear
          php artisan cache:clear
          php artisan route:clear
          php artisan view:clear
          
          echo "âš¡ Optimisation..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          # Permissions
          echo "ðŸ” Configuration des permissions..."
          chmod -R 775 storage bootstrap/cache
          chown -R $USER:www-data storage bootstrap/cache
          
          # CrÃ©er le lien symbolique pour storage
          php artisan storage:link || true
          
          echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"
        ENDSSH
    
    - name: Deploy Status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… DÃ©ploiement rÃ©ussi sur NitroHost !"
        else
          echo "âŒ Ã‰chec du dÃ©ploiement"
          exit 1
        fi