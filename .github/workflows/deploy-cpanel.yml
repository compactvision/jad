name: Deploy Laravel to cPanel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸšš Checkout code
      uses: actions/checkout@v3
    
    - name: ðŸ”§ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, mysql, gd, bcmath, zip
    
    - name: ðŸ“¦ Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
    
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: ðŸ“¥ Install NPM dependencies
      run: npm ci
    
    - name: ðŸ”¨ Build assets (Vite)
      run: npm run build
    
    - name: ðŸ“‹ Prepare deployment files
      run: |
        # CrÃ©er la structure pour cPanel
        mkdir -p deploy/laravel_app
        mkdir -p deploy/public_html
        
        # Copier les fichiers Laravel dans laravel_app
        rsync -av --exclude='node_modules' \
                  --exclude='.git' \
                  --exclude='tests' \
                  --exclude='public' \
                  --exclude='deploy' \
                  ./ deploy/laravel_app/
        
        # Copier le contenu de public dans public_html
        cp -r public/* deploy/public_html/
        
        # S'assurer que le .env n'est pas inclus (on le crÃ©era sur le serveur)
        rm -f deploy/laravel_app/.env
    
    - name: ðŸš€ Deploy to cPanel via FTP
      uses: SamKirkland/[email protected]
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./deploy/
        server-dir: ./
        dangerous-clean-slate: false
        
    - name: âœ… Deployment complete
      run: echo "ðŸŽ‰ DÃ©ploiement terminÃ© avec succÃ¨s !"