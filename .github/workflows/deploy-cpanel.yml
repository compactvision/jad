name: Deploy Laravel to cPanel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸšš Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ”§ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, mysql, gd, bcmath, zip
    
    - name: ğŸ“¦ Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: ğŸ“¥ Install NPM dependencies
      run: npm ci
    
    - name: ğŸ”¨ Build assets (Vite)
      run: npm run build
    
    - name: ğŸ“‹ Prepare deployment files
      run: |
        mkdir -p deploy/laravel_app
        mkdir -p deploy/public_html
        
        # Copier les fichiers Laravel
        rsync -av --exclude='node_modules' \
                  --exclude='.git' \
                  --exclude='tests' \
                  --exclude='public' \
                  --exclude='deploy' \
                  ./ deploy/laravel_app/
        
        # Copier le contenu public
        cp -r public/* deploy/public_html/
        
        rm -f deploy/laravel_app/.env
    
    # NOUVELLE VERSION avec plus d'options
    - name: ğŸš€ Deploy to cPanel via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.6
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./deploy/
        server-dir: ./
        protocol: ftps  # â† CHANGEMENT ICI
        port: 21
        timeout: 300000  # 5 minutes
        dangerous-clean-slate: false
        log-level: verbose
        
    - name: âœ… Deployment complete
      run: echo "ğŸ‰ DÃ©ploiement terminÃ© avec succÃ¨s !"